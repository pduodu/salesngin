@model OrderViewModel
@inject IDataControllerService _dataService
@{
    ViewData["Title"] = "Orders";
    ViewData["MainMenu"] = "Order Management";
    //ViewData["SubMenu"] = "Orders";
    ViewData["Page"] = "Orders";

    //Use this to configure the datatables toolbar
    ViewBag.ToolBarDateFilter = true; //Table has a date column
    ViewBag.ToolBarStatusFilter = true;//Table has a status filter column
    ViewBag.ToolBarStatusFilterOptions = GlobalConstants.OrderTypes;
    ViewBag.ToolBarExportOptions = true;

    var settings = await _dataService.GetSettings();
}

<!--begin::Card-->
<div class="card mx-auto mb-6 mb-xl-9">
    <div class="card-header pt-5">
        <div class="card-title">
            <h2 class="d-flex align-items-center">
                Orders
                <span class="text-gray-600 fs-6 ms-1">(@Model.Orders?.Count)</span>
            </h2>
        </div>
        <div class="card-toolbar">
            <div class="input-group mb-5 w-100 float-end">

                <form method="get" asp-controller="Order" asp-action="Orders" class="w-100">
                    <div class="input-group w-100 float-end fs-6">

                        <div class="me-3">
                            <label for="monthSelect" class="visually-hidden">Month</label>
                            <select id="monthSelect" name="month" class="form-select form-select-lg types-select">
                                <option value="0">Month: All</option>
                                @foreach (var month in Model.ActiveMonths)
                                {
                                    <option value="@month.value" selected="@(Model.ActiveMonth == month.value ? "selected" : null)">@month.name</option>
                                }
                            </select>
                        </div>

                        <div class="me-3">
                            <label for="yearSelect" class="visually-hidden">Year</label>
                            <select id="yearSelect" name="year" class="form-select form-select-lg types-select">
                                <option value="0">Year: All</option>
                                @foreach (int year in Model.ActiveYears.Take(10))
                                {
                                    <option value="@year" selected="@(Model.ActiveYear == year ? "selected" : null)">@year</option>
                                }
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="ki-duotone ki-filter fs-2 me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            Apply Filter
                        </button>
                    </div>
                </form>

            </div>
        </div>
    </div>
    <div class="card-header">
        <div class="card-title">
            @{
                if (Model.ModulePermission.Create == true){
                    <ul class="nav nav-pills nav-pills-custom mb-3 mt-3" role="tablist">
                        <li class="nav-item mb-3 me-3 me-lg-6" role="presentation">
                            <a asp-controller="Order" asp-action="CreateOrder" class="nav-link d-flex justify-content-between flex-column flex-center overflow-hidden active w-80px h-85px py-4">
                                <div class="nav-icon">
                                    <i class="ki-duotone ki-plus-square fs-2qx mx-2 text-primary"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i>
                                </div>
                                <span class="nav-text text-gray-700 fw-bold fs-6 lh-1">
                                    Create
                                </span>
                                <span class="bullet-custom position-absolute bottom-0 w-100 h-4px bg-primary"></span>
                            </a>
                        </li>
                    </ul>
                }
            }
        </div>
        <div class="card-toolbar">
            <ul class="nav nav-pills nav-pills-custom mb-3 mt-3" role="tablist">
                <li class="nav-item mb-3 me-3 me-lg-6" role="presentation">
                    <a asp-controller="Order" asp-action="Orders" asp-route-status="" class="nav-link d-flex justify-content-between flex-column flex-center overflow-hidden w-85px h-85px py-4 bg-hover-light-primary">
                        <div class="nav-icon">
                            <i class="ki-duotone ki-abstract-26 fs-2qx mx-2 text-primary"><i class="path1"></i><i class="path2"></i></i>
                        </div>
                        <span class="nav-text text-gray-700 fw-bold fs-6 lh-1">
                            All
                        </span>
                        <span class="bullet-custom position-absolute bottom-0 w-100 h-4px bg-primary"></span>
                    </a>
                </li>
                <li class="nav-item mb-3 me-3 me-lg-6" role="presentation">
                    <a asp-controller="Order" asp-action="Orders" asp-route-status="@OrderStatus.Hold" class="nav-link d-flex justify-content-between flex-column flex-center overflow-hidden w-85px h-85px py-4 bg-hover-light-primary ">
                        <div class="nav-icon">
                            <i class="ki-duotone ki-bookmark-2 fs-2qx mx-2 text-primary">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                        </div>
                        <span class="nav-text text-gray-700 fw-bold fs-6 lh-1">
                            Held
                        </span>
                        <span class="bullet-custom position-absolute bottom-0 w-100 h-4px bg-primary"></span>
                    </a>
                </li>
                <li class="nav-item mb-3 me-3 me-lg-6" role="presentation">
                    <a asp-controller="Order" asp-action="Orders" asp-route-status="@OrderStatus.Ready" class="nav-link d-flex justify-content-between flex-column flex-center overflow-hidden w-85px h-85px py-4 bg-hover-light-success">
                        <div class="nav-icon">
                            <i class="ki-duotone ki-double-check text-success mx-2 fs-2qx">
                                <i class="path1"></i>
                                <i class="path2"></i>
                            </i>
                        </div>
                        <span class="nav-text text-gray-700 fw-bold fs-6 lh-1">
                            Ready
                        </span>
                        <span class="bullet-custom position-absolute bottom-0 w-100 h-4px bg-primary"></span>
                    </a>
                </li>
                <li class="nav-item mb-3 me-3 me-lg-6" role="presentation">
                    <a asp-controller="Order" asp-action="Orders" asp-route-status="@OrderStatus.Delivered" class="nav-link d-flex justify-content-between flex-column flex-center overflow-hidden w-85px h-85px py-4 bg-hover-light-success">
                        <div class="nav-icon">
                            <i class="ki-duotone ki-user-tick fs-2qx mx-2 text-success"><i class="path1"></i><i class="path2"></i><i class="path3"></i></i>
                        </div>
                        <span class="nav-text text-gray-700 fw-bold fs-6 lh-1">
                            Delivered
                        </span>
                        <span class="bullet-custom position-absolute bottom-0 w-100 h-4px bg-primary"></span>
                    </a>
                </li>
                <li class="nav-item mb-3 me-3 me-lg-6" role="presentation">
                    <a asp-controller="Order" asp-action="Orders" asp-route-status="@OrderStatus.Cancelled" class="nav-link d-flex justify-content-between flex-column flex-center overflow-hidden w-85px h-85px py-4 bg-hover-light-danger">
                        <div class="nav-icon">
                            <i class="ki-duotone ki-cross text-danger mx-2 fs-2qx">
                                <i class="path1"></i>
                                <i class="path2"></i>
                            </i>
                        </div>
                        <span class="nav-text text-gray-700 fw-bold fs-6 lh-1">
                            Cancelled
                        </span>
                        <span class="bullet-custom position-absolute bottom-0 w-100 h-4px bg-primary"></span>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    @await Html.PartialAsync("_TableToolbar")
    <div id="divTbPlaceholder" class="card-body py-4">
        <div class="table-responsive">
            <table class="table align-middle table-row-dashed table-hover fs-6 gy-3 gs-3" id="tbl_datatable_records">
                <thead>
                    <tr class="text-start text-gray-900 fw-bolder fs-7 text-uppercase gs-0">
                        <th>#</th>
                        <th>Order Number</th>
                        @* <th>Customer</th> *@
                        <th>Total Amount @settings.Currency </th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th class="text-end"></th>
                    </tr>
                </thead>
                <tbody class="text-gray-900 fw-bold">

                    @{
                        if (Model.Orders.Count > 0)
                        {
                            int i = 0;
                            foreach (var order in Model.Orders)
                            {
                                i++;
                                string dataUrl = "#";
                                if (Model.ModulePermission.Update)
                                {
                                    dataUrl = @Url.Action("Details", "Order", new { id = @order.Id });
                                    @* string[] editableOrderStatuses = [OrderStatus.New, OrderStatus.Ready, OrderStatus.Hold];
                                    if (editableOrderStatuses.Contains(order.Status))
                                    {
                                        dataUrl = @Url.Action("UpdateItem", "Items", new { id = @order.Id });
                                    } *@
                                }
                                <tr class="cursor-pointer" data-url="@dataUrl" onclick="navigateToRowLink(this);">
                                    <td>@i</td>
                                    <td><a id="lnkCode_@i" class="btn btn-sm btn-light-primary fw-bold fs-5" asp-controller="Order" asp-action="Details" asp-route-id="@order.Id">@order.OrderCode</a></td>
                                    @* <td>@order.CustomerName @order.CustomerNumber</td> *@
                                    <td>@Html.DisplayFor(modelItem => order.TotalAmount)</td>
                                    <td>@await Html.PartialAsync("Order/_OrderType", @order.OrderType)</td>
                                    <td><a id="lnkStatus_@i" asp-controller="Order" asp-action="Details" asp-route-id="@order.Id">@await Html.PartialAsync("Order/_OrderStatus", @order.Status)</a></td>
                                    <td>@Html.DisplayFor(modelItem => order.OrderDate)</td>
                                    <td class="text-end">
                                        @* @{
                                            if (Model.ModulePermission.Update)
                                            {
                                                <a class="btn btn-icon btn-active-light-primary w-30px h-30px mx-3" asp-controller="Order" asp-action="Details" asp-route-id="@order.Id" data-toggle="tooltip" title="View">
                                                    <i class="ki-duotone ki-eye fs-2qx"><i class="path1"></i><i class="path2"></i><i class="path3"></i></i>
                                                </a>
                                            }

                                            if (Model.ModulePermission.Update)
                                            {
                                                string[] editableOrderStatuses = [OrderStatus.New, OrderStatus.Ready, OrderStatus.Hold];
                                                if (editableOrderStatuses.Contains(order.Status))
                                                {
                                                    <a class="btn btn-icon btn-active-light-primary w-30px h-30px mx-3" asp-controller="Order" asp-action="Edit" asp-route-id="@order.Id" data-toggle="tooltip" title="Edit">
                                                        <i class="ki-duotone ki-pencil fs-2qx">
                                                            <span class="path1"></span>
                                                            <span class="path2"></span>
                                                        </i>
                                                    </a>
                                                }
                                            }

                                            if (Model.ModulePermission.Delete)
                                            {

                                                <button class="btn btn-icon btn-active-light-danger w-30px h-30px" type="submit" value="Delete" onclick="return swalConfirm('@order.Id', this)" data-toggle="tooltip" title="Delete">
                                                    <i class="ki-duotone ki-trash fs-2qx">
                                                        <span class="path1"></span>
                                                        <span class="path2"></span>
                                                        <span class="path3"></span>
                                                        <span class="path4"></span>
                                                        <span class="path5"></span>
                                                    </i>
                                                </button>
                                                <form id="actionForm_@order.Id" asp-controller="Order" asp-action="Delete" asp-route-id="@order.Id" method="post">
                                                </form>
                                            }
                                        } *@
                                    </td>
                                </tr>
                            }
                        }
                    }

                </tbody>
                <!--end::Table body-->
            </table>
            <!--end::Table-->
        </div>
    </div>
    <!--end::Card body-->

</div>

<!--begin::Alert-->
@* <div class="alert bg-light-success d-flex flex-center flex-column py-10 px-10 px-lg-20 mb-10">
    <i class="ki-duotone ki-notification-on fs-5tx text-success mb-5"><i class="path1"></i><i class="path2"></i><i class="path3"></i><i class="path4"></i><i class="path5"></i></i>
    <div class="text-center">
        <h1 class="fw-bold mb-5">Order Sent!</h1>
        <div class="separator separator-dashed border-danger opacity-25 mb-5"></div>
        <div class="mb-9 text-dark"><h4>Your order number is : <b>123WES</b></h4></div>
    </div></div> *@

@* <i class="ki-duotone ki-verify"><i class="path1"></i><i class="path2"></i></i> *@
@* <i class="ki-duotone ki-information-5 fs-5tx text-danger mb-5"><span class="path1"></span><span class="path2"></span><span class="path3"></span></i> *@
<!--end::Alert-->
<!--end::Card-->
@section Scripts {
    <script>

        document.addEventListener('DOMContentLoaded', function () {

            $('.types-select').select2({ width: 'resolve' });

            KTUtil.onDOMContentLoaded(function () {
                KTAppTableListing.init("tbl_datatable_records", "tbl_daterange_flatpickr",
                    "searchInput", "tbl_status", [], "Date", "Type",
                    "tbl_daterange_flatpickr_clear",
                    "datatable_export_buttons", "datatable_table_export_menu");
            });

        });

        function navigateToRowLink(element)
        {
            var url = $(element).data('url');
            //console.log(url); // This should log the correct URL
            if (url)
            {
                window.location.href = url;
            }
        }


    </script>
}
