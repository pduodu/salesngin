@model UserViewModel
@inject IDataControllerService _dataService
@{
    ViewData["Title"] = "Users";
    ViewData["MainMenu"] = "User Management";
    //ViewData["SubMenu"] = "Users";
    ViewData["Page"] = "Users";
    //Get Users permission to View Profile
    //var createPermission = await _dataService.GetModuleActionPermission(ConstantModules.User_Module, Model.UserLoggedIn.Id, ConstantPermissions.Create);
    var createPermission = Model.ModulePermission.Create == true ? true : false;
}


<!--begin::Card-->
<div class="card  mx-auto mb-6 mb-xl-9">
    <div class="card-header pt-5">
        <div class="card-title">
            <h2 class="d-flex align-items-center">
                Users
            </h2>
        </div>
        <div class="card-toolbar">
            @{
                if (Model.ModulePermission.Create)
                {
                    <a asp-controller="Account" asp-action="Create" class="btn btn-primary px-3 mx-2">Create</a>
                }
            }
        </div>
    </div>
    <!--begin::Card header-->
    @await Html.PartialAsync("_TableToolbar")
    <!--end::Card header-->
    <!--begin::Card body-->
    <div id="divTbPlaceholder" class="card-body py-4">
        @* @await Html.PartialAsync("_UsersTable", Model) *@

        <div class="table-responsive">
            <!--begin::Table-->
            <table class="table align-middle table-row-dashed fs-6 gy-5 gs-5" id="tbl_user_records">
                <!--begin::Table head-->
                <thead>
                    <!--begin::Table row-->
                    <tr class="text-start text-muted fw-bolder fs-7 text-uppercase gs-0">
                        <th>User</th>
                        <th>Staff Number</th>
                        <th>Job Title</th>
                        <th>Status</th>
                        <th>Date loggedIn</th>
                        <th class="text-end">Actions</th>
                    </tr>
                    <!--end::Table row-->
                </thead>
                <!--end::Table head-->
                <!--begin::Table body-->
                <tbody class="text-gray-600 fw-bold">

                    @{
                        if (Model.Employees.Count > 0)
                        {

                            async Task<bool> ShouldDisplayUser(ApplicationUser employee)
                            {
                                return !(await _dataService.IsEmployeeInRole(employee.Id, ApplicationRoles.SuperAdministrator) && !await _dataService.IsUserInRole(Model.UserLoggedIn.Id, ApplicationRoles.SuperAdministrator));
                            }

                            int i = 0;
                            foreach (var employee in Model.Employees)
                            {
                                i++;
                                if (await ShouldDisplayUser(employee))
                                {
                                    <tr>
                                        <!--begin::User=-->
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <!--begin::Wrapper-->
                                                <div class="me-5 position-relative">
                                                    <!--begin::Avatar-->
                                                    @{
                                                        if (createPermission)
                                                        {
                                                            //User has permission to View Profile
                                                            <a asp-controller="Account" asp-action="Profile" asp-route-id="@employee.Id">
                                                                <div class="symbol symbol-40px symbol-circle">
                                                                    <img alt="@employee.UserInitials" src="@Url.Content(employee.UserPhotoPath)">
                                                                </div>
                                                            </a>
                                                        }
                                                        else
                                                        {
                                                            //User dose not have permission to View Profile
                                                            <div class="symbol symbol-40px symbol-circle">
                                                                <img alt="@employee.UserInitials" src="@Url.Content(employee.UserPhotoPath)">
                                                            </div>
                                                        }
                                                    }
                                                    <!--end::Avatar-->
                                                </div>
                                                <!--end::Wrapper-->
                                                <!--begin::Info-->
                                                <div class="d-flex flex-column justify-content-center">
                                                    @{
                                                        if (createPermission)
                                                        {
                                                            <a asp-controller="Account" asp-action="Profile" asp-route-id="@employee.Id" class="text-gray-800 text-hover-primary mb-1">@employee.FullName</a>
                                                        }
                                                        else
                                                        {
                                                            <a href="#" class="text-gray-800 text-hover-secondary mb-1">@employee.FullName</a>
                                                        }
                                                    }
                                                    <div class="fw-bold fs-6 text-gray-400">@employee.Email</div>
                                                </div>
                                                <!--end::Info-->
                                            </div>
                                        </td>
                                        <td>@employee.StaffNumber</td>
                                        <td>@employee.JobTitle</td>
                                        <td>
                                            @{
                                                //     if (employee.User.IsActive == true)
                                                //     {
                                                //         <span class="badge badge-light-success fw-bolder px-4 py-3">Active</span>
                                                //     }
                                                //     else
                                                //     {
                                                //         <span class="badge badge-light-danger fw-bolder px-4 py-3">InActive</span>
                                                //     }

                                                var statusParameters = new { UserId = @employee.Id, UserStatus = employee.IsActive, ModulePermission = Model.ModulePermission };
                                                @await Html.PartialAsync("User/_UserAccountStatus", statusParameters)
                                            }
                                        </td>
                                        <td>@Html.DisplayFor(modelItem => employee.LastLogin)</td>
                                        <td class="text-end">
                                            @{
                                                if (await _dataService.GetModuleActionPermission(ConstantModules.User_Module, Model.UserLoggedIn.Id, ConstantPermissions.Update))
                                                {
                                                    <a asp-controller="Account" asp-action="Profile" asp-route-id="@employee.Id" class="btn btn-light-primary px-3 mr-2">
                                                        <i class="ki-duotone ki-pencil fs-2x">
                                                            <span class="path1"></span>
                                                            <span class="path2"></span>
                                                        </i>
                                                    </a>
                                                }

                                                if (await _dataService.GetModuleActionPermission(ConstantModules.User_Module, Model.UserLoggedIn.Id, ConstantPermissions.Delete))
                                                {

                                                    <button class="btn btn-light-danger px-3" type="submit" value="Delete" form="actionForm_@employee.Id" onclick="return swalConfirm('@employee.Id', this)">
                                                        <i class="ki-duotone ki-trash fs-2x">
                                                            <span class="path1"></span>
                                                            <span class="path2"></span>
                                                            <span class="path3"></span>
                                                            <span class="path4"></span>
                                                            <span class="path5"></span>
                                                        </i>
                                                    </button>
                                                    <form id="actionForm_@employee.Id" asp-controller="Account" asp-action="DeleteUser" asp-route-id="@employee.Id" method="post">
                                                    </form>
                                                }
                                            }
                                        </td>
                                    </tr>
                                }
                            }
                        }
                    }

                </tbody>
                <!--end::Table body-->
            </table>
            <!--end::Table-->
        </div>
    </div>
    <!--end::Card body-->
</div>
<!--end::Card-->
@section Scripts {
    @*<script src="~/assets/js/tableConfig.js"></script>*@
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            $('.types-select').select2({ width: 'resolve' });

            KTUtil.onDOMContentLoaded(function () {
                KTAppTableListing.init("tbl_user_records", "tbl_daterange_flatpickr",
                    "searchInput", "tbl_status", [], "Date", "Status",
                    "tbl_daterange_flatpickr_clear",
                    "datatable_export_buttons", "datatable_table_export_menu");
            });


            // Initialize DataTable with parameters
            // Usage example:
            // Assume "Date" and "Status" are part of the column headers.
            // Pass the IDs for export buttons container and export menu from the view
            // KTAppTableListing.init("kt_ecommerce_sales_table", "kt_ecommerce_sales_flatpickr",
            // "kt_ecommerce_sales_search", "kt_ecommerce_sales_status",
            // [/* Specify sum column indices here */],"Date", "Status",
            // "kt_clear_date_range_btn",
            // "kt_datatable_export_buttons", "kt_datatable_table_export_menu");

        });

    </script>
}
